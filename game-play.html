<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>í‹€ë¦°ê·¸ë¦¼ì°¾ê¸° ê²Œì„</title>
  
  <!-- ìºì‹œ ë¬´ë ¥í™” ìŠ¤í¬ë¦½íŠ¸ (ê°œë°œìš©) -->
  <script src="assets/js/cache-buster.js"></script>
  
  <!-- JavaScript ê°•ì œ ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸ (ê°œë°œìš©) -->
  <script src="assets/js/force-js-execution.js"></script>
  
  <!-- ì‘ê¸‰ CSS ì£¼ì… ìŠ¤í¬ë¦½íŠ¸ (ê°œë°œìš©) -->
  <script src="assets/js/emergency-css-injection.js"></script>
  
  <!-- CSS ëª¨ë“ˆ -->
  <!-- CSS ê¸°ë³¸ ëª¨ë“ˆë“¤ -->
  <link rel="stylesheet" href="assets/css/game/variables.css">
  <link rel="stylesheet" href="assets/css/game/base.css">
  <link rel="stylesheet" href="assets/css/game/layout.css">
  <link rel="stylesheet" href="assets/css/game/components.css">
  <link rel="stylesheet" href="assets/css/game/health-bar.css">
  <link rel="stylesheet" href="assets/css/game/animations.css">
  <link rel="stylesheet" href="assets/css/game/responsive.css">
  
  <!-- íšŒì „ ì•ˆë‚´ UI ì˜¤ë²„ë ˆì´ -->
  <link rel="stylesheet" href="assets/css/game/orientation.css">
  
  <!-- ë©”ì¸ ê²Œì„ ìŠ¤íƒ€ì¼ -->
  <link rel="stylesheet" href="assets/css/game-play.css">
  </head>
  <body>
  <!-- íšŒì „ ì•ˆë‚´ ì˜¤ë²„ë ˆì´ -->
  <div class="orientation-overlay">
    <div class="orientation-game-name">í‹€ë¦°ê·¸ë¦¼ì°¾ê¸°</div>
    <div class="rotate-icon-container">
      <div class="phone-icon"></div>
      <div class="rotate-arrow">â†»</div>
    </div>
    <div class="orientation-text">
      <div class="orientation-title">ğŸ“± í•¸ë“œí°ì„ íšŒì „í•˜ì„¸ìš”</div>
      <div class="orientation-subtitle">ë” ë‚˜ì€ ê²Œì„ ê²½í—˜ì„ ìœ„í•´<br>ê°€ë¡œëª¨ë“œë¡œ í”Œë ˆì´í•´ì£¼ì„¸ìš”</div>
    </div>
  </div>

  <!-- ìƒë‹¨ í—¤ë”: ê²Œì„ ì œëª© + ì‚¬ìš©ì ì •ë³´ -->
    <header class="game-header-top">
      <div class="game-header">
        <h1 class="game-title">í‹€ë¦°ê·¸ë¦¼ì°¾ê¸° ê²Œì„</h1>
      </div>
      
      <!-- ì‚¬ìš©ì ì •ë³´ ì˜ì—­ -->
      <div class="user-section" id="userSection">
        <!-- ì¸ì¦ ê´€ë¦¬ìê°€ ë™ì ìœ¼ë¡œ ì±„ì›€ -->
      </div>
    </header>
    
    <!-- ë©”ì¸ ë ˆì´ì•„ì›ƒ ë˜í¼ (ê·¸ë¦¬ë“œ: ì½˜í…ì¸  + ì‚¬ì´ë“œë°”) -->
    <div class="main-layout-wrapper">
      <!-- ë©”ì¸ ì½˜í…ì¸  ì˜ì—­ -->
      <div class="main-layout-content">
    <!-- ë©”ì¸ ì´ë¯¸ì§€ ì˜ì—­ -->
    <main class="main-content">
      <div class="images-container" id="imagesContainer" style="display: none;">
        <div class="image-section">
          <h3>ì›ë³¸ ì´ë¯¸ì§€</h3>
          <div class="image-container" id="originalContainer">
            <img id="originalImage" class="game-image" src="" alt="ì›ë³¸ ì´ë¯¸ì§€">
          </div>
        </div>
        
        <div class="image-section">
          <h3>ìˆ˜ì • ì´ë¯¸ì§€ (ì—¬ê¸°ì„œ ì°¾ìœ¼ì„¸ìš”!)</h3>
          <div class="image-container" id="modifiedContainer">
            <img id="modifiedImage" class="game-image" src="" alt="ìˆ˜ì • ì´ë¯¸ì§€">
          </div>
        </div>
      </div>
    </main>
      </div> <!-- main-layout-content ì¢…ë£Œ -->
      
      <!-- ì˜¤ë¥¸ìª½ ì‚¬ì´ë“œë°” (ë°ìŠ¤í¬í†± ì „ìš©, ë°”í…€ë°”ì™€ ë™ì¼í•œ êµ¬ì¡°) -->
      <div class="right-sidebar">
        <!-- ì‚¬ì´ë“œë°” ê²Œì„ í†µê³„ ì„¹ì…˜ -->
        <div class="sidebar-section sidebar-stats">
          <h4>ê²Œì„ ì •ë³´</h4>
          <div class="sidebar-stats-grid">
            <div class="sidebar-stat-item">
              <span class="sidebar-stat-label">ì ìˆ˜</span>
              <span class="sidebar-stat-value" id="sidebarScore">0</span>
            </div>
            <div class="sidebar-stat-item">
              <span class="sidebar-stat-label">ì‹œê°„</span>
              <span class="sidebar-stat-value" id="sidebarTimer">00:00</span>
            </div>
            <div class="sidebar-stat-item">
              <span class="sidebar-stat-label">ì§„í–‰</span>
              <span class="sidebar-stat-value" id="sidebarFound">0/0</span>
            </div>
            <div class="sidebar-stat-item">
              <span class="sidebar-stat-label">ìƒëª…</span>
              <span class="sidebar-stat-value" id="sidebarLives">â¤ï¸â¤ï¸â¤ï¸â¤ï¸â¤ï¸</span>
            </div>
          </div>
        </div>
        
        <!-- ì‚¬ì´ë“œë°” ì§„í–‰ë°” ì„¹ì…˜ -->
        <div class="sidebar-section sidebar-progress">
          <h4>ì²´ë ¥</h4>
          <!-- ì²´ë ¥ë°” (ì‹œê°„ ì œí•œ ì‹œê°í™”) -->
          <div class="sidebar-health-bar-section" id="sidebarHealthBarSection">
            <div class="health-bar">
              <div class="health-bar-fill" id="sidebarHealthBarFill"></div>
              <div class="health-bar-text" id="sidebarHealthBarText">100%</div>
            </div>
          </div>
        </div>
        
        <!-- ì‚¬ì´ë“œë°” ì»¨íŠ¸ë¡¤ ì„¹ì…˜ -->
        <div class="sidebar-section sidebar-controls">
          <h4>ê²Œì„ ì œì–´</h4>
          <div class="sidebar-controls-grid">
            <button class="sidebar-btn btn-primary" id="sidebarStartBtn">ê²Œì„ ì‹œì‘</button>
            <button class="sidebar-btn hint-btn" id="sidebarHintBtn" disabled>ğŸ’¡ íŒíŠ¸</button>
          </div>
        </div>
      </div> <!-- right-sidebar ì¢…ë£Œ -->
    </div> <!-- main-layout-wrapper ì¢…ë£Œ -->
  
    <!-- ë°”í…€ë°” ì œê±°ë¨: ì‚¬ì´ë“œë°” ì‹œìŠ¤í…œìœ¼ë¡œ ì™„ì „ ì „í™˜ -->
          
            <!-- JavaScript ëª¨ë“ˆë“¤ -->
  <!-- Supabase í´ë¼ì´ì–¸íŠ¸ -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <!-- ëª¨ë“ˆ ë¡œë”© ì‹œìŠ¤í…œ (ì˜ì¡´ì„± ê´€ë¦¬) -->
  <script src="assets/js/module-loader.js"></script>
  
  <!-- ê²Œì„ ìŠ¤í¬ë¦½íŠ¸ë“¤ -->
  <script src="assets/js/game-state.js"></script>
  <script src="assets/js/orientation-controller.js"></script>
  <script src="assets/js/layout-manager.js"></script>
  <script src="assets/js/heart-system.js"></script>
  <script src="assets/js/health-bar-system.js"></script>
  <script src="assets/js/coordinate-utils.js"></script>
  <script src="assets/js/api-client.js"></script>
  <script src="assets/js/game-logic.js"></script>
  <script src="assets/js/click-handler.js"></script>
  <script src="assets/js/answer-display.js"></script>
  
  <!-- ë©”ì¸ ê²Œì„ ì´ˆê¸°í™” -->
  <script>
    console.log('ğŸ® ê²Œì„ ì‹œì‘!');
    
    // ì¸ì¦ ìƒíƒœ ìºì‹œ ë³€ìˆ˜
    let authStateCache = null;
    let lastAuthCheck = 0;
    const AUTH_CACHE_DURATION = 30000; // 30ì´ˆ ìºì‹œ
    
    // ì¸ì¦ ìƒíƒœ ìºì‹œ í´ë¦¬ì–´
    function clearAuthCache() {
      authStateCache = null;
      lastAuthCheck = 0;
      console.log('ì¸ì¦ ìƒíƒœ ìºì‹œê°€ í´ë¦¬ì–´ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }
    // ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
    // ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
    function showMessage(message, type = 'error') {
      const errorEl = document.getElementById('errorMessage');
      const successEl = document.getElementById('successMessage');
      
      // DOM ìš”ì†Œê°€ ì—†ìœ¼ë©´ ì½˜ì†”ë¡œ ë©”ì‹œì§€ ì¶œë ¥
      if (!errorEl || !successEl) {
        console.log(`ğŸ“± [${type.toUpperCase()}] ${message}`);
        return;
      }
      
      errorEl.style.display = 'none';
      successEl.style.display = 'none';
      
      if (type === 'error') {
        errorEl.textContent = message;
        errorEl.style.display = 'block';
      } else {
        successEl.textContent = message;
        successEl.style.display = 'block';
      }
      
      setTimeout(() => {
        if (errorEl) errorEl.style.display = 'none';
        if (successEl) successEl.style.display = 'none';
      }, 3000);
    }
    
    // ì¸ì¦ ìƒíƒœ í™•ì¸ í•¨ìˆ˜ (ê°„ë‹¨í•œ ëŒ€ì²´ êµ¬í˜„)
    async function checkAuthState() {
      try {
        // ìºì‹œëœ ê²°ê³¼ê°€ ìˆê³  30ì´ˆ ì´ë‚´ë©´ ì‚¬ìš©
        const now = Date.now();
        if (authStateCache && (now - lastAuthCheck) < AUTH_CACHE_DURATION) {
          console.log('ğŸ“„ ìºì‹œëœ ì¸ì¦ ìƒíƒœ ë°˜í™˜:', authStateCache);
          return authStateCache;
        }
        
        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ í† í° í™•ì¸
        const token = localStorage.getItem('supabaseToken');
        const user = localStorage.getItem('supabaseUser');
        const expiry = localStorage.getItem('supabaseTokenExpiry');
        
        if (!token || !user) {
          console.log('âŒ í† í° ë˜ëŠ” ì‚¬ìš©ì ì •ë³´ ì—†ìŒ');
          authStateCache = { isAuthenticated: false, user: null };
          lastAuthCheck = now;
          return authStateCache;
        }
        
        // í† í° ë§Œë£Œ í™•ì¸
        if (expiry && parseInt(expiry) < now) {
          console.log('â° í† í° ë§Œë£Œë¨');
          localStorage.removeItem('supabaseToken');
          localStorage.removeItem('supabaseUser');
          localStorage.removeItem('supabaseTokenExpiry');
          authStateCache = { isAuthenticated: false, user: null };
          lastAuthCheck = now;
          return authStateCache;
        }
        
        // ì‚¬ìš©ì ì •ë³´ íŒŒì‹±
        let userObj;
        try {
          userObj = JSON.parse(user);
        } catch (parseError) {
          console.error('ì‚¬ìš©ì ì •ë³´ íŒŒì‹± ì˜¤ë¥˜:', parseError);
          authStateCache = { isAuthenticated: false, user: null };
          lastAuthCheck = now;
          return authStateCache;
        }
        
        console.log('âœ… ì¸ì¦ëœ ì‚¬ìš©ì:', { id: userObj.id, email: userObj.email });
        authStateCache = { isAuthenticated: true, user: userObj };
        lastAuthCheck = now;
        return authStateCache;
        
      } catch (error) {
        console.error('âŒ ì¸ì¦ ìƒíƒœ í™•ì¸ ì˜¤ë¥˜:', error);
        authStateCache = { isAuthenticated: false, user: null };
        lastAuthCheck = Date.now();
        return authStateCache;
      }
    }
    function showLoading(show = true) {
      const loadingEl = document.getElementById('loading');
      
      // DOM ìš”ì†Œê°€ ì—†ìœ¼ë©´ ì½˜ì†”ë¡œ ë©”ì‹œì§€ ì¶œë ¥
      if (!loadingEl) {
        console.log(`ğŸ”„ [LOADING] ${show ? 'ë¡œë”© ì‹œì‘' : 'ë¡œë”© ì¢…ë£Œ'}`);
        return;
      }
      
      if (show) {
        loadingEl.style.display = 'block';
        setTimeout(() => {
          if (loadingEl) loadingEl.style.display = 'none';
        }, 10000);
      } else {
        loadingEl.style.display = 'none';
      }
    }
    
    // íŒíŠ¸ ê¸°ëŠ¥
    let hintCount = 0;
    const maxHints = 5;
    
    function showHint() {
      if (!gameState.isGameActive || gameState.isPaused) {
        showMessage('ê²Œì„ì´ ì§„í–‰ ì¤‘ì¼ ë•Œë§Œ íŒíŠ¸ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'error');
        return;
      }
      
      if (hintCount >= maxHints) {
        showMessage('íŒíŠ¸ë¥¼ ëª¨ë‘ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.', 'error');
        return;
      }
      
      if (!gameState.answerPoints || gameState.answerPoints.length === 0) {
        showMessage('ê²Œì„ ë°ì´í„°ê°€ ë¡œë”©ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', 'error');
        return;
      }
      
      // ì•„ì§ ì°¾ì§€ ëª»í•œ ì˜ì—­ë“¤ ì¤‘ì—ì„œ ëœë¤í•˜ê²Œ í•˜ë‚˜ ì„ íƒ
      const unfoundRegions = gameState.answerPoints
        .map((_, index) => index)
        .filter(index => !gameState.foundPoints.includes(index));
      
      if (unfoundRegions.length === 0) {
        showMessage('ëª¨ë“  ì •ë‹µì„ ì°¾ì•˜ìŠµë‹ˆë‹¤!', 'success');
        return;
      }
      
      // ëœë¤í•˜ê²Œ í•˜ë‚˜ì˜ ì˜ì—­ ì„ íƒ
      const randomIndex = Math.floor(Math.random() * unfoundRegions.length);
      const hintRegionIndex = unfoundRegions[randomIndex];
      
      // íŒíŠ¸ ì‚¬ìš© íšŸìˆ˜ ì¦ê°€
      hintCount++;
      
      // ì„ íƒëœ ì˜ì—­ì„ 3ì´ˆê°„ ê¹œë¹¡ì´ê²Œ í•¨
      showDifferenceBlinking(hintRegionIndex, 3000);
      
      // íŒíŠ¸ ë²„íŠ¼ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
      updateHintButton();
      
      showMessage(`íŒíŠ¸! ê¹œë¹¡ì´ëŠ” ì˜ì—­ì„ í™•ì¸í•˜ì„¸ìš” (${hintCount}/${maxHints})`, 'success');
      
      console.log('ğŸ’¡ íŒíŠ¸ ì‚¬ìš©:', {
        ì‚¬ìš©íšŸìˆ˜: `${hintCount}/${maxHints}`,
        íŒíŠ¸ì˜ì—­: hintRegionIndex,
        ë‚¨ì€ë¯¸ë°œê²¬ì˜ì—­: unfoundRegions.length - 1
      });
    }
    
    function updateHintButton() {
      const hintBtn = document.getElementById('hintBtn');
      if (hintBtn) {
        const remaining = maxHints - hintCount;
        hintBtn.textContent = `ğŸ’¡ íŒíŠ¸ (${remaining}/${maxHints})`;
        
        if (remaining === 0) {
          hintBtn.disabled = true;
          hintBtn.style.opacity = '0.5';
        } else {
          hintBtn.disabled = false;
          hintBtn.style.opacity = '1';
        }
      }
    }
    
    // ê²Œì„ ì‹œì‘ ì‹œ íŒíŠ¸ ì´ˆê¸°í™”
    function resetHintSystem() {
      hintCount = 0;
      updateHintButton();
      console.log('ğŸ”„ íŒíŠ¸ ì‹œìŠ¤í…œ ì´ˆê¸°í™”');
    
    }

    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
    function setupEventListeners() {
      console.log('ğŸ”§ [DEBUG] setupEventListeners í˜¸ì¶œë¨!');
      
      // ê²Œì„ ì œì–´ ë²„íŠ¼ë“¤
      const startBtn = document.getElementById('startBtn');
      const resetBtn = document.getElementById('resetBtn');
      
      console.log('ğŸ¯ [DEBUG] ë²„íŠ¼ ìš”ì†Œ í™•ì¸:', {
        startBtn: startBtn,
        resetBtn: resetBtn,
        startBtnId: startBtn?.id,
        resetBtnId: resetBtn?.id
      });
      
      // ë²„íŠ¼ ìœ„ì¹˜ ì •ë³´ í™•ì¸
      if (startBtn && resetBtn) {
        const startRect = startBtn.getBoundingClientRect();
        const resetRect = resetBtn.getBoundingClientRect();
        
        console.log('ğŸ“ [DEBUG] ë²„íŠ¼ ìœ„ì¹˜ ì •ë³´:', {
          startBtn: {
            x: startRect.x,
            y: startRect.y,
            width: startRect.width,
            height: startRect.height,
            right: startRect.right,
            bottom: startRect.bottom
          },
          resetBtn: {
            x: resetRect.x,
            y: resetRect.y,
            width: resetRect.width,
            height: resetRect.height,
            right: resetRect.right,
            bottom: resetRect.bottom
          }
        });
        
        // ê²¹ì¹¨ ì—¬ë¶€ í™•ì¸
        const isOverlapping = !(
          startRect.right < resetRect.left || 
          resetRect.right < startRect.left || 
          startRect.bottom < resetRect.top || 
          resetRect.bottom < startRect.top
        );
        
        console.log(`${isOverlapping ? 'âŒ [WARNING]' : 'âœ… [OK]'} ë²„íŠ¼ ê²¹ì¹¨ ì—¬ë¶€: ${isOverlapping}`);
      }
      if (startBtn) {
        console.log('ğŸš€ [DEBUG] startBtnì— startGame ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡');
        startBtn.addEventListener('click', function(event) {
          console.log('ğŸ”´ [DEBUG] START ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ë°œìƒ!', event.target);
          startGame();
        });
      }
      
      if (resetBtn) {
        console.log('ğŸ”„ [DEBUG] resetBtnì— resetGame ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡');
        resetBtn.addEventListener('click', function(event) {
          console.log('ğŸ”µ [DEBUG] RESET ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ë°œìƒ!', event.target);
          resetGame();
        });
      }
      

      document.getElementById('hintBtn')?.addEventListener('click', showHint);
      document.getElementById('newGameBtn')?.addEventListener('click', () => {
        window.location.href = '../index.html';
      });
      document.getElementById('toggleAnswerBtn')?.addEventListener('click', toggleAnswerPoints);
      
      // ë””ë²„ê·¸ ëª¨ë“œ í† ê¸€
      document.getElementById('debugModeBtn')?.addEventListener('click', () => {
        debugMode = !debugMode;
        const btn = document.getElementById('debugModeBtn');
        const devTools = document.getElementById('devTools');
        
        // ë²„íŠ¼ í…ìŠ¤íŠ¸ì™€ ìƒ‰ìƒ ë™ì‹œ ì—…ë°ì´íŠ¸
        btn.textContent = debugMode ? 'ğŸ”§ ë””ë²„ê·¸ OFF' : 'ğŸ”§ ë””ë²„ê·¸ ëª¨ë“œ';
        btn.style.backgroundColor = debugMode ? '#e74c3c' : '#f39c12';
        
        // ê°œë°œì ë„êµ¬ íŒ¨ë„ í† ê¸€
        devTools.style.display = debugMode ? 'block' : 'none';
        
        showMessage(`ë””ë²„ê·¸ ëª¨ë“œ ${debugMode ? 'ON' : 'OFF'}`, 'success');
        });
        
      
      // ì´ë¯¸ì§€ í´ë¦­ ì´ë²¤íŠ¸
      const modifiedImg = document.getElementById('modifiedImage');
      if (modifiedImg) {
        modifiedImg.addEventListener('click', (event) => {
          if (debugMode) {
            debugClickHandler(event);
          } else {
            handleImageClick(event);
          }
        });
      }
      
      console.log('âœ… ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì™„ë£Œ');
    }
    
    window.addEventListener('load', async function() {
      console.log('ğŸ“± í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ, í‘œì¤€í™”ëœ ì´ˆê¸°í™” ì‹œì‘!');
      
      try {
        // === 1ë‹¨ê³„: í‘œì¤€í™”ëœ ì´ˆê¸°í™” (ë§í¬ ì†ŒìŠ¤ ë¬´ê´€) ===
        
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        setupEventListeners();
        
        // ì¸ì¦ ìƒíƒœ ìºì‹œ ê°•ì œ í´ë¦¬ì–´ (ì¼ê´€ì„± ë³´ì¥)
        clearAuthCache();
        console.log('ğŸ”„ ì¸ì¦ ìƒíƒœ ìºì‹œ ê°•ì œ í´ë¦¬ì–´ ì™„ë£Œ');
        
        // ê²Œì„ ìƒíƒœ ì´ˆê¸°í™” (ëª¨ë“  ì ‘ì†ì—ì„œ ë™ì¼í•œ ì‹œì‘ì )
        resetGameState();
        console.log('ğŸ® ê²Œì„ ìƒíƒœ í‘œì¤€í™” ì´ˆê¸°í™” ì™„ë£Œ');
        
        // === 2ë‹¨ê³„: í™˜ê²½ ì„¤ì • ë¡œë“œ ===
        
        // í™˜ê²½ë³€ìˆ˜ë¥¼ APIì—ì„œ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
        async function loadSupabaseConfig() {
          try {
            const response = await fetch('/api/config');
            const config = await response.json();
            return {
              url: config.supabaseUrl,
              anonKey: config.anon_key
            };
          } catch (error) {
            console.error('ì„¤ì • ë¡œë“œ ì˜¤ë¥˜:', error);
            // í´ë°±: í•˜ë“œì½”ë”©ëœ ê°’ ì‚¬ìš©
            return {
              url: 'https://ysvxjmqdafldfrmdscvd.supabase.co',
              anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlzdnhqbXFkYWZsZGZybWRzY3ZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDIxODU5ODMsImV4cCI6MjA1Nzc2MTk4M30.lKRd0cPCFLMJFWT1lMrp7DOAjlx85Q-pbnsXTiE22G4'
            };
          }
        }
        
        // === 3ë‹¨ê³„: OAuth í† í° ì²˜ë¦¬ (ëª¨ë“  ë§í¬ì—ì„œ ë™ì¼í•œ ë°©ì‹) ===
        
        // URL fragment ì •ë¦¬ (í† í° ì—¬ë¶€ì™€ ê´€ê³„ì—†ì´ í•­ìƒ ì‹¤í–‰)
        const urlParams = new URLSearchParams(window.location.hash.substring(1));
        const accessToken = urlParams.get('access_token');
        const refreshToken = urlParams.get('refresh_token');
        const expiresAt = urlParams.get('expires_at');
        
        // URL ì •ë¦¬ (í† í° ì œê±°) - ëª¨ë“  ê²½ìš°ì— ì‹¤í–‰
        if (window.location.hash) {
          window.history.replaceState({}, document.title, window.location.pathname + window.location.search);
          console.log('ğŸ§¹ URL fragment ì •ë¦¬ ì™„ë£Œ');
        }
        
        // OAuth í† í°ì´ ìˆëŠ” ê²½ìš°ì—ë§Œ ì²˜ë¦¬
        if (accessToken && refreshToken) {
          console.log('ğŸ”‘ OAuth í† í° ë°œê²¬, ì„¸ì…˜ ì„¤ì • ì¤‘...');
          try {
            // Supabase ì„¤ì •ì„ APIì—ì„œ ê°€ì ¸ì˜¤ê¸°
            const config = await loadSupabaseConfig();
            
            // Supabase í´ë¼ì´ì–¸íŠ¸ ê°€ì ¸ì˜¤ê¸° (ì´ë¯¸ ìƒì„±ëœ í´ë¼ì´ì–¸íŠ¸ ë˜ëŠ” ìƒˆë¡œ ìƒì„±)
            let supabaseClient = window.supabaseClient;
            if (!supabaseClient && window.supabase) {
              supabaseClient = window.supabase.createClient(config.url, config.anonKey);
              window.supabaseClient = supabaseClient;
            }
            
            const sessionData = {
              access_token: accessToken,
              refresh_token: refreshToken,
              expires_at: expiresAt ? parseInt(expiresAt) : Math.floor(Date.now() / 1000) + 3600,
              token_type: 'bearer',
              user: null // Supabaseê°€ ìë™ìœ¼ë¡œ ì„¤ì •í•¨
            };
            
            const { data, error } = await supabaseClient.auth.setSession(sessionData);
            
            if (error) {
              console.error('âŒ ì„¸ì…˜ ì„¤ì • ì‹¤íŒ¨:', error);
            } else {
              console.log('âœ… ì„¸ì…˜ ì„¤ì • ì„±ê³µ:', data);
              
              // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ë„ í† í° ì €ì¥
              localStorage.setItem('supabaseToken', accessToken);
              localStorage.setItem('supabaseTokenExpiry', String(sessionData.expires_at * 1000));
              
              if (data.user) {
                localStorage.setItem('supabaseUser', JSON.stringify(data.user));
              }
            }
          } catch (tokenError) {
            console.warn('âš ï¸ í† í° ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:', tokenError);
          }
          
          // í† í° ì²˜ë¦¬ í›„ ì•ˆì •í™” ëŒ€ê¸°
          await new Promise(resolve => setTimeout(resolve, 500));
        }
        
        // === 4ë‹¨ê³„: ì¸ì¦ ìƒíƒœ í™•ì¸ ë° UI ì—…ë°ì´íŠ¸ (í‘œì¤€í™”) ===
        
        // ì¸ì¦ ìƒíƒœ ì¬í™•ì¸ (ìºì‹œ ë¬´íš¨í™” í›„)
        clearAuthCache();
        
        try {
          const authState = await checkAuthState();
          console.log('ğŸ” ìµœì¢… ì¸ì¦ ìƒíƒœ:', authState);
          
          // ë¡œê·¸ì¸ëœ ì‚¬ìš©ìì˜ ê²½ìš°ì—ë§Œ í•˜íŠ¸ ì‹œìŠ¤í…œ ì´ˆê¸°í™”
          if (authState.isAuthenticated && authState.user) {
            try {
              const heartInitSuccess = await window.heartSystem.init(authState.user.id);
              if (heartInitSuccess) {
                console.log('ğŸ’– í•˜íŠ¸ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì„±ê³µ');
              } else {
                console.warn('âš ï¸ í•˜íŠ¸ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì‹¤íŒ¨, ê²ŒìŠ¤íŠ¸ ëª¨ë“œë¡œ ì§„í–‰');
              }
            } catch (heartError) {
              console.warn('âš ï¸ í•˜íŠ¸ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜:', heartError.message);
              console.log('ê²ŒìŠ¤íŠ¸ ëª¨ë“œë¡œ ì§„í–‰í•©ë‹ˆë‹¤.');
            }
          } else {
            console.log('ğŸ‘¤ ê²ŒìŠ¤íŠ¸ ëª¨ë“œë¡œ ì§„í–‰í•©ë‹ˆë‹¤.');
          }
          
          await updateUserInterface();
        } catch (authError) {
          console.warn('âš ï¸ ì¸ì¦ í™•ì¸ ì‹¤íŒ¨:', authError.message);
          console.log('ê²ŒìŠ¤íŠ¸ ëª¨ë“œë¡œ ì§„í–‰í•©ë‹ˆë‹¤.');
          await updateUserInterface();
        }
        
        // === 5ë‹¨ê³„: ê²Œì„ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ===
        
        // ì‹œê°„ ì œí•œ ì‹œê°í™” ì‹œìŠ¤í…œ ì´ˆê¸°í™”
        console.log('ğŸ” healthBarSystem ì¡´ì¬ ì—¬ë¶€:', typeof window.healthBarSystem);
        if (typeof window.healthBarSystem !== 'undefined') {
          console.log('ğŸ” healthBarSection DOM ìš”ì†Œ ìƒíƒœ:', {
            ìš”ì†Œì¡´ì¬: !!document.getElementById('healthBarSection'),
            í´ë˜ìŠ¤: document.getElementById('healthBarSection')?.className,
            í‘œì‹œìƒíƒœ: document.getElementById('healthBarSection') ? window.getComputedStyle(document.getElementById('healthBarSection')).display : 'N/A'
          });
          
          const healthBarInitSuccess = window.healthBarSystem.init();
          if (healthBarInitSuccess) {
            console.log('â±ï¸ ì‹œê°„ ì œí•œ ì‹œê°í™” ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì„±ê³µ');
          } else {
            console.warn('âš ï¸ ì‹œê°„ ì œí•œ ì‹œê°í™” ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì‹¤íŒ¨');
          }
        } else {
          console.error('âŒ healthBarSystemì´ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!');
        }
        
        // ê²Œì„ ë°ì´í„° ë¡œë”© (í‘œì¤€í™”ëœ ìˆœì„œ)
        await loadGameData();
        
        // ì²´ë ¥ë°” ì‹œìŠ¤í…œ ì‹œì‘ (ê²Œì„ ë°ì´í„° ë¡œë”© í›„)
        if (typeof window.healthBarSystem !== 'undefined') {
          console.log('ğŸš€ ì²´ë ¥ë°” ì‹œìŠ¤í…œ ìˆ˜ë™ ì‹œì‘...');
          window.healthBarSystem.start();
          console.log('âœ… ì²´ë ¥ë°” ì‹œìŠ¤í…œ ìˆ˜ë™ ì‹œì‘ ì™„ë£Œ');
        }
        
        // UI ì—…ë°ì´íŠ¸ (ëª¨ë“  ì´ˆê¸°í™” ì™„ë£Œ í›„)
        updateUI();
        
        // Orientation Controller ì´ˆê¸°í™” ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        if (typeof window.orientationController !== 'undefined') {
          console.log('ğŸ”„ Orientation Controller ì´ˆê¸°í™”...');
          
          // OrientationController ì´ˆê¸°í™”
          window.orientationController.initOrientation();
          
          // Orientation ë³€ê²½ ì‹œ ê²Œì„ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
          window.orientationController.addCallback('orientationChange', (data) => {
            console.log('ğŸ“± Orientation ë³€ê²½ ê°ì§€:', data);
            updateGameButtonStates();
          });
          
          // ì´ˆê¸° ê²Œì„ ë²„íŠ¼ ìƒíƒœ ì„¤ì •
          updateGameButtonStates();
          
          console.log('âœ… Orientation Controller ì´ˆê¸°í™” ì™„ë£Œ');
        } else {
          console.warn('âš ï¸ OrientationControllerë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
        }
        
        // === ìµœì¢… ì™„ë£Œ ë©”ì‹œì§€ ===
        showMessage('ê²Œì„ ì¤€ë¹„ ì™„ë£Œ! ì‹œì‘ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.', 'success');
        console.log('ğŸ‰ í‘œì¤€í™”ëœ ì´ˆê¸°í™” ì™„ë£Œ - ëª¨ë“  ë§í¬ ì†ŒìŠ¤ì—ì„œ ë™ì¼í•œ ìƒíƒœ');
        
      } catch (error) {
        console.error('âŒ ê²Œì„ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
        showMessage(`ê²Œì„ ì´ˆê¸°í™” ì‹¤íŒ¨: ${error.message}`, 'error');
      }
    });
    
    /**
     * ì‚¬ìš©ì ì¸í„°í˜ì´ìŠ¤ ì—…ë°ì´íŠ¸
     */
    async function updateUserInterface() {
      const userSection = document.getElementById('userSection');
      const bestScoreSection = document.getElementById('bestScoreSection');
      const bestScoreEl = document.getElementById('bestScore');
      
      try {
                const authState = await checkAuthState();
        
        if (userSection) {
          if (authState.isAuthenticated && authState.user) {
            // ë¡œê·¸ì¸ ìƒíƒœ UI
            userSection.innerHTML = `
              <div class="user-info">
                <div class="user-avatar">
                  <img src="${authState.user.user_metadata?.avatar_url || 'https://via.placeholder.com/40x40/4CAF50/FFFFFF?text=U'}" 
                       alt="í”„ë¡œí•„" style="width: 40px; height: 40px; border-radius: 50%;">
                </div>
                <div class="user-details">
                  <div class="user-name">ğŸ‘‹ ${authState.user.user_metadata?.full_name || authState.user.email}</div>
                  <div class="user-email">${authState.user.email}</div>
                </div>
                <button onclick="logout()" class="control-btn btn-secondary" style="margin-top: 10px;">ë¡œê·¸ì•„ì›ƒ</button>
              </div>
            `;
          } else {
            // ê²ŒìŠ¤íŠ¸ ìƒíƒœ UI
            userSection.innerHTML = `
              <div class="guest-info">
                <div class="guest-message">
                  <span>ğŸ® ê²ŒìŠ¤íŠ¸ ëª¨ë“œ</span>
                  <div style="font-size: 12px; color: #888; margin: 5px 0;">
                    ë¡œê·¸ì¸í•˜ë©´ ë” ë§ì€ ê¸°ëŠ¥ì„ ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!
                  </div>
                </div>
                <button onclick="loginWithGoogle()" class="control-btn btn-primary" style="margin-top: 10px;">
                  <span>ğŸ”‘ êµ¬ê¸€ ë¡œê·¸ì¸</span>
                </button>
              </div>
            `;
          }
        }
        
        // ë¡œê·¸ì¸ëœ ì‚¬ìš©ìì˜ ìµœê³  ì ìˆ˜ í‘œì‹œ
        if (authState.isAuthenticated && bestScoreSection && bestScoreEl) {
          try {
            // ìµœê³  ì ìˆ˜ ê¸°ëŠ¥ì€ í–¥í›„ êµ¬í˜„ ì˜ˆì •
            if (bestScoreSection) {
              bestScoreSection.style.display = 'none';
            }
          } catch (error) {
            console.log('ìµœê³  ì ìˆ˜ APIê°€ êµ¬í˜„ë˜ì§€ ì•ŠìŒ:', error.message);
            if (bestScoreSection) {
              bestScoreSection.style.display = 'none';
            }
          }
        }
      } catch (error) {
        console.error('ì‚¬ìš©ì ì¸í„°í˜ì´ìŠ¤ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
      }
    }
    
    // ê²Œì„ ì‹œì‘ ì „ ì •ë‹µ ì˜ì—­ ìˆ¨ê¹€
    window.addEventListener('beforeunload', () => {
      hideAnswerPoints();
    });

    /**
     * ê°œë°œììš© íŒíŠ¸ ë¦¬ì…‹ í•¨ìˆ˜
     */
    async function resetDeveloperHints() {
      try {
                const authState = await checkAuthState();
        
        // ë¡œê·¸ì¸ëœ ì‚¬ìš©ìì¸ì§€ í™•ì¸ (ê°œë°œì ê¶Œí•œì€ í–¥í›„ êµ¬í˜„)
        if (authState.isAuthenticated) {
          // íŒíŠ¸ ë°ì´í„° ë¦¬ì…‹ ë¡œì§ (í–¥í›„ êµ¬í˜„ ì˜ˆì •)
          showMessage('ğŸ› ï¸ íŒíŠ¸ ë¦¬ì…‹ ê¸°ëŠ¥ì€ í–¥í›„ êµ¬í˜„ ì˜ˆì •ì…ë‹ˆë‹¤.', 'success');
        } else {
          showMessage('ì´ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error');
        }
      } catch (error) {
        console.error('ê°œë°œì íŒíŠ¸ ë¦¬ì…‹ ì˜¤ë¥˜:', error);
        showMessage('ê¸°ëŠ¥ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
      }
    }

    // ì „ì—­ í•¨ìˆ˜ë¡œ ë…¸ì¶œ
    window.showLoading = showLoading;
    window.showMessage = showMessage;
    window.resetDeveloperHints = resetDeveloperHints;
    
    // authModuleì„ ì „ì—­ authManagerë¡œ ë…¸ì¶œ (ëŒ€ì²´ êµ¬í˜„)
    // window.authManager = authModule;
    
    // ì¸ì¦ ê´€ë ¨ ì „ì—­ í•¨ìˆ˜
    window.loginWithGoogle = async () => {
      try {
        // ê°„ë‹¨í•œ êµ¬ê¸€ ë¡œê·¸ì¸ ëŒ€ì²´ êµ¬í˜„
        console.log('êµ¬ê¸€ ë¡œê·¸ì¸ ìš”ì²­');
        // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
        window.location.href = '/login.html';
      } catch (error) {
        console.error('êµ¬ê¸€ ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜:', error);
        showMessage('ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
      }
    };
    window.logout = async () => {
      try {
        // ì¸ì¦ ìºì‹œ ë¨¼ì € í´ë¦¬ì–´
        clearAuthCache();
        
        // ê°„ë‹¨í•œ ë¡œê·¸ì•„ì›ƒ ëŒ€ì²´ êµ¬í˜„
        console.log('ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬');
        localStorage.removeItem('supabaseToken');
        localStorage.removeItem('supabaseUser');
        localStorage.removeItem('supabaseTokenExpiry');
        
        showMessage('ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.', 'success');
        // 2ì´ˆ í›„ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
        setTimeout(() => {
          window.location.href = '/login.html';
        }, 2000);
      } catch (error) {
        console.error('ë¡œê·¸ì•„ì›ƒ ì¤‘ ì˜¤ë¥˜:', error);
        showMessage('ë¡œê·¸ì•„ì›ƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
      }
    };
    </script>
    
    
    </body>
    </html>