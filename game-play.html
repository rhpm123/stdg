<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>í‹€ë¦°ê·¸ë¦¼ì°¾ê¸° ê²Œì„</title>
  
  <!-- CSS ëª¨ë“ˆ -->
  <!-- CSS ê¸°ë³¸ ëª¨ë“ˆë“¤ -->
  <link rel="stylesheet" href="assets/css/game/variables.css">
  <link rel="stylesheet" href="assets/css/game/base.css">
  <link rel="stylesheet" href="assets/css/game/layout.css">
  <link rel="stylesheet" href="assets/css/game/components.css">
  <link rel="stylesheet" href="assets/css/game/health-bar.css">
  <link rel="stylesheet" href="assets/css/game/animations.css">
  <link rel="stylesheet" href="assets/css/game/responsive.css">
  
  <!-- ë©”ì¸ ê²Œì„ ìŠ¤íƒ€ì¼ -->
  <link rel="stylesheet" href="assets/css/game-play.css">
  </head>
  <body>
  <!-- ìƒë‹¨ í—¤ë”: ê²Œì„ ì œëª© + ì‚¬ìš©ì ì •ë³´ -->
    <header class="game-header-top">
      <div class="game-header">
        <h1 class="game-title">í‹€ë¦°ê·¸ë¦¼ì°¾ê¸° ê²Œì„</h1>
      </div>
      
      <!-- ì‚¬ìš©ì ì •ë³´ ì˜ì—­ -->
      <div class="user-section" id="userSection">
        <!-- ì¸ì¦ ê´€ë¦¬ìê°€ ë™ì ìœ¼ë¡œ ì±„ì›€ -->
      </div>
    </header>
    
    <!-- ë©”ì¸ ì´ë¯¸ì§€ ì˜ì—­ -->
    <main class="main-content">
      <div class="images-container" id="imagesContainer" style="display: none;">
        <div class="image-section">
          <h3>ì›ë³¸ ì´ë¯¸ì§€</h3>
          <div class="image-container" id="originalContainer">
            <img id="originalImage" class="game-image" src="" alt="ì›ë³¸ ì´ë¯¸ì§€">
          </div>
        </div>
        
        <div class="image-section">
          <h3>ìˆ˜ì • ì´ë¯¸ì§€ (ì—¬ê¸°ì„œ ì°¾ìœ¼ì„¸ìš”!)</h3>
          <div class="image-container" id="modifiedContainer">
            <img id="modifiedImage" class="game-image" src="" alt="ìˆ˜ì • ì´ë¯¸ì§€">
          </div>
        </div>
      </div>
    </main>
  
    <!-- í•˜ë‹¨ ë°”: ê²Œì„ í†µê³„ + ì§„í–‰ë°” + ì»¨íŠ¸ë¡¤ ë²„íŠ¼ -->
    <div class="bottom-bar">
      <!-- ê²Œì„ í†µê³„ ì„¹ì…˜ -->
      <div class="bottom-bar-stats">
        <div class="game-stats">
          <div class="stat-item">
            <div class="stat-label">ì ìˆ˜</div>
            <div class="stat-value" id="score">0</div>
          </div>
          
          <div class="stat-item">
            <div class="stat-label">ì‹œê°„</div>
            <div class="stat-value" id="timer">00:00</div>
          </div>
          
          <div class="stat-item">
            <div class="stat-label">ì§„í–‰ë¥ </div>
            <div class="stat-value" id="progress">0%</div>
          </div>
          
          <div class="stat-item">
            <div class="stat-label">ì°¾ì€ ê°œìˆ˜</div>
            <div class="stat-value" id="found">0/0</div>
          </div>
          
          <div class="stat-item">
            <div class="stat-label">ëª©ìˆ¨</div>
            <div class="stat-value" id="lives">â¤ï¸â¤ï¸â¤ï¸â¤ï¸â¤ï¸</div>
          </div>
          
          <!-- ì²´ë ¥ë°” ì„¹ì…˜ -->
          <div class="stat-item" id="healthBarSection">
            <div class="stat-label">ì‹œê°„</div>
            <div class="health-bar-container">
              <div class="health-bar" id="healthBar">
                <div class="health-bar-fill" id="healthBarFill"></div>
                <div class="health-bar-text" id="healthBarText">100%</div>
              </div>
            </div>
          </div>
          
          <!-- ë¡œê·¸ì¸ ì‚¬ìš©ìë§Œ í‘œì‹œë˜ëŠ” ìµœê³  ì ìˆ˜ -->
          <div class="stat-item" id="bestScoreSection" style="display: none;">
            <div class="stat-label">ìµœê³  ì ìˆ˜</div>
            <div class="stat-value" id="bestScore">-</div>
          </div>
        </div>
      </div>
      
      <!-- ì§„í–‰ë°” ì„¹ì…˜ -->
      <div class="bottom-bar-progress">
        <div class="progress-bar">
          <div class="progress-fill" id="progressBar"></div>
        </div>
      </div>
      
      <!-- ì»¨íŠ¸ë¡¤ ë²„íŠ¼ ì„¹ì…˜ -->
      <div class="bottom-bar-controls">
        <div class="game-controls">
          <button class="control-btn btn-primary" id="startBtn">ê²Œì„ ì‹œì‘</button>
          <button class="control-btn btn-secondary" id="pauseBtn" disabled>ì¼ì‹œì •ì§€</button>
          <button class="control-btn btn-secondary" id="resetBtn">ë‹¤ì‹œ ì‹œì‘</button>
          <button class="control-btn hint-btn" id="hintBtn" disabled>ğŸ’¡ íŒíŠ¸ (5/5)</button>
          <button class="control-btn btn-secondary" id="newGameBtn">ë‹¤ë¥¸ ê²Œì„ ì„ íƒ</button>
          <button class="control-btn btn-secondary" id="toggleAnswerBtn" style="background-color: #9b59b6; border-color: #8e44ad;">ì •ë‹µ ì˜ì—­ í‘œì‹œ</button>
          <button class="control-btn btn-warning" id="debugModeBtn" style="background-color: #f39c12; border-color: #e67e22;">ğŸ”§ ë””ë²„ê·¸ ëª¨ë“œ</button>
        </div>
        
        <!-- íŒíŠ¸ ì •ë³´ ì„¹ì…˜ -->
        <div class="hint-info" id="hintInfo">
          <div class="hint-counter" id="hintCounter">ê²Œì„: 3/3 | ì¼ì¼: 10/10</div>
          <div style="font-size: 10px; margin-top: 3px; color: #999;">
            íŒíŠ¸ ì‚¬ìš© ì‹œ 50ì  ì°¨ê°ë©ë‹ˆë‹¤
          </div>
        </div>
          
          <!-- ê°œë°œì ë„êµ¬ (ê°œë°œ ë‹¨ê³„ìš©) -->
          <div class="dev-tools" id="devTools" style="display: none;">
            <div class="dev-tools-header">
              <h4>ğŸ› ï¸ ê°œë°œì ë„êµ¬</h4>
            </div>
            <button class="control-btn btn-info" onclick="showAnswerHint()">ğŸ’¡ íŒíŠ¸</button>
            <button class="control-btn btn-info" onclick="showDifferenceBlinking()">âœ¨ í‹€ë¦°ë¶€ë¶„ ê¹œë°•ì„</button>
            <button class="control-btn btn-info" onclick="toggleAnswerPoints()">ğŸ“ ì •ë‹µ í‘œì‹œ</button>
            <button class="control-btn btn-warning" onclick="resetDeveloperHints()" style="background-color: #e67e22; border-color: #d35400;">ğŸ”„ íŒíŠ¸ ë¦¬ì…‹</button>
          </div>
          
          <!-- ë©”ì‹œì§€ ì˜ì—­ -->
          <div id="messageArea" class="message-area">
            <div id="errorMessage" class="sidebar-message error-msg" style="display: none;"></div>
            <div id="successMessage" class="sidebar-message success-msg" style="display: none;"></div>
            <div id="loading" class="sidebar-message loading-msg" style="display: none;">ğŸ“Š ë°ì´í„° ë¡œë”©ì¤‘...</div>
          </div>
          </div>
          </div>

  <!-- JavaScript ëª¨ë“ˆë“¤ -->
  <!-- Supabase í´ë¼ì´ì–¸íŠ¸ -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <!-- ê²Œì„ ìŠ¤í¬ë¦½íŠ¸ë“¤ -->
  <script src="assets/js/game-state.js"></script>
  <script src="assets/js/heart-system.js"></script>
  <script src="assets/js/health-bar-system.js"></script>
  <script src="assets/js/coordinate-utils.js"></script>
  <script src="assets/js/api-client.js"></script>
  <script src="assets/js/game-logic.js"></script>
  <script src="assets/js/click-handler.js"></script>
  <script src="assets/js/answer-display.js"></script>
  
  <!-- ë©”ì¸ ê²Œì„ ì´ˆê¸°í™” -->
  <script>
    console.log('ğŸ® ê²Œì„ ì‹œì‘!');
    
    // ì¸ì¦ ìƒíƒœ ìºì‹œ ë³€ìˆ˜
    let authStateCache = null;
    let lastAuthCheck = 0;
    const AUTH_CACHE_DURATION = 30000; // 30ì´ˆ ìºì‹œ
    
    // ì¸ì¦ ìƒíƒœ ìºì‹œ í´ë¦¬ì–´
    function clearAuthCache() {
      authStateCache = null;
      lastAuthCheck = 0;
      console.log('ì¸ì¦ ìƒíƒœ ìºì‹œê°€ í´ë¦¬ì–´ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }
    // ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
    // ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
    function showMessage(message, type = 'error') {
      const errorEl = document.getElementById('errorMessage');
      const successEl = document.getElementById('successMessage');
      
      errorEl.style.display = 'none';
      successEl.style.display = 'none';
      
      if (type === 'error') {
        errorEl.textContent = message;
        errorEl.style.display = 'block';
      } else {
        successEl.textContent = message;
        successEl.style.display = 'block';
      }
      
      setTimeout(() => {
        errorEl.style.display = 'none';
        successEl.style.display = 'none';
      }, 3000);
    }
    
    // ì¸ì¦ ìƒíƒœ í™•ì¸ í•¨ìˆ˜ (ê°„ë‹¨í•œ ëŒ€ì²´ êµ¬í˜„)
    async function checkAuthState() {
      try {
        // ìºì‹œëœ ê²°ê³¼ê°€ ìˆê³  30ì´ˆ ì´ë‚´ë©´ ì‚¬ìš©
        const now = Date.now();
        if (authStateCache && (now - lastAuthCheck) < AUTH_CACHE_DURATION) {
          console.log('ğŸ“„ ìºì‹œëœ ì¸ì¦ ìƒíƒœ ë°˜í™˜:', authStateCache);
          return authStateCache;
        }
        
        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ í† í° í™•ì¸
        const token = localStorage.getItem('supabaseToken');
        const user = localStorage.getItem('supabaseUser');
        const expiry = localStorage.getItem('supabaseTokenExpiry');
        
        if (!token || !user) {
          console.log('âŒ í† í° ë˜ëŠ” ì‚¬ìš©ì ì •ë³´ ì—†ìŒ');
          authStateCache = { isAuthenticated: false, user: null };
          lastAuthCheck = now;
          return authStateCache;
        }
        
        // í† í° ë§Œë£Œ í™•ì¸
        if (expiry && parseInt(expiry) < now) {
          console.log('â° í† í° ë§Œë£Œë¨');
          localStorage.removeItem('supabaseToken');
          localStorage.removeItem('supabaseUser');
          localStorage.removeItem('supabaseTokenExpiry');
          authStateCache = { isAuthenticated: false, user: null };
          lastAuthCheck = now;
          return authStateCache;
        }
        
        // ì‚¬ìš©ì ì •ë³´ íŒŒì‹±
        let userObj;
        try {
          userObj = JSON.parse(user);
        } catch (parseError) {
          console.error('ì‚¬ìš©ì ì •ë³´ íŒŒì‹± ì˜¤ë¥˜:', parseError);
          authStateCache = { isAuthenticated: false, user: null };
          lastAuthCheck = now;
          return authStateCache;
        }
        
        console.log('âœ… ì¸ì¦ëœ ì‚¬ìš©ì:', { id: userObj.id, email: userObj.email });
        authStateCache = { isAuthenticated: true, user: userObj };
        lastAuthCheck = now;
        return authStateCache;
        
      } catch (error) {
        console.error('âŒ ì¸ì¦ ìƒíƒœ í™•ì¸ ì˜¤ë¥˜:', error);
        authStateCache = { isAuthenticated: false, user: null };
        lastAuthCheck = Date.now();
        return authStateCache;
      }
    }
    function showLoading(show = true) {
      const loadingEl = document.getElementById('loading');
      if (show) {
        loadingEl.style.display = 'block';
        setTimeout(() => {
          loadingEl.style.display = 'none';
        }, 10000);
      } else {
        loadingEl.style.display = 'none';
      }
    }
    
    // íŒíŠ¸ ê¸°ëŠ¥
    let hintCount = 0;
    const maxHints = 5;
    
    function showHint() {
      if (!gameState.isGameActive || gameState.isPaused) {
        showMessage('ê²Œì„ì´ ì§„í–‰ ì¤‘ì¼ ë•Œë§Œ íŒíŠ¸ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'error');
        return;
      }
      
      if (hintCount >= maxHints) {
        showMessage('íŒíŠ¸ë¥¼ ëª¨ë‘ ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤.', 'error');
        return;
      }
      
      if (!gameState.answerPoints || gameState.answerPoints.length === 0) {
        showMessage('ê²Œì„ ë°ì´í„°ê°€ ë¡œë”©ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', 'error');
        return;
      }
      
      // ì•„ì§ ì°¾ì§€ ëª»í•œ ì˜ì—­ë“¤ ì¤‘ì—ì„œ ëœë¤í•˜ê²Œ í•˜ë‚˜ ì„ íƒ
      const unfoundRegions = gameState.answerPoints
        .map((_, index) => index)
        .filter(index => !gameState.foundPoints.includes(index));
      
      if (unfoundRegions.length === 0) {
        showMessage('ëª¨ë“  ì •ë‹µì„ ì°¾ì•˜ìŠµë‹ˆë‹¤!', 'success');
        return;
      }
      
      // ëœë¤í•˜ê²Œ í•˜ë‚˜ì˜ ì˜ì—­ ì„ íƒ
      const randomIndex = Math.floor(Math.random() * unfoundRegions.length);
      const hintRegionIndex = unfoundRegions[randomIndex];
      
      // íŒíŠ¸ ì‚¬ìš© íšŸìˆ˜ ì¦ê°€
      hintCount++;
      
      // ì„ íƒëœ ì˜ì—­ì„ 3ì´ˆê°„ ê¹œë¹¡ì´ê²Œ í•¨
      showDifferenceBlinking(hintRegionIndex, 3000);
      
      // íŒíŠ¸ ë²„íŠ¼ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
      updateHintButton();
      
      showMessage(`íŒíŠ¸! ê¹œë¹¡ì´ëŠ” ì˜ì—­ì„ í™•ì¸í•˜ì„¸ìš” (${hintCount}/${maxHints})`, 'success');
      
      console.log('ğŸ’¡ íŒíŠ¸ ì‚¬ìš©:', {
        ì‚¬ìš©íšŸìˆ˜: `${hintCount}/${maxHints}`,
        íŒíŠ¸ì˜ì—­: hintRegionIndex,
        ë‚¨ì€ë¯¸ë°œê²¬ì˜ì—­: unfoundRegions.length - 1
      });
    }
    
    function updateHintButton() {
      const hintBtn = document.getElementById('hintBtn');
      if (hintBtn) {
        const remaining = maxHints - hintCount;
        hintBtn.textContent = `ğŸ’¡ íŒíŠ¸ (${remaining}/${maxHints})`;
        
        if (remaining === 0) {
          hintBtn.disabled = true;
          hintBtn.style.opacity = '0.5';
        } else {
          hintBtn.disabled = false;
          hintBtn.style.opacity = '1';
        }
      }
    }
    
    // ê²Œì„ ì‹œì‘ ì‹œ íŒíŠ¸ ì´ˆê¸°í™”
    function resetHintSystem() {
      hintCount = 0;
      updateHintButton();
      console.log('ğŸ”„ íŒíŠ¸ ì‹œìŠ¤í…œ ì´ˆê¸°í™”');
    
    }

    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
    function setupEventListeners() {
      console.log('ğŸ”§ [DEBUG] setupEventListeners í˜¸ì¶œë¨!');
      
      // ê²Œì„ ì œì–´ ë²„íŠ¼ë“¤
      const startBtn = document.getElementById('startBtn');
      const resetBtn = document.getElementById('resetBtn');
      
      console.log('ğŸ¯ [DEBUG] ë²„íŠ¼ ìš”ì†Œ í™•ì¸:', {
        startBtn: startBtn,
        resetBtn: resetBtn,
        startBtnId: startBtn?.id,
        resetBtnId: resetBtn?.id
      });
      
      // ë²„íŠ¼ ìœ„ì¹˜ ì •ë³´ í™•ì¸
      if (startBtn && resetBtn) {
        const startRect = startBtn.getBoundingClientRect();
        const resetRect = resetBtn.getBoundingClientRect();
        
        console.log('ğŸ“ [DEBUG] ë²„íŠ¼ ìœ„ì¹˜ ì •ë³´:', {
          startBtn: {
            x: startRect.x,
            y: startRect.y,
            width: startRect.width,
            height: startRect.height,
            right: startRect.right,
            bottom: startRect.bottom
          },
          resetBtn: {
            x: resetRect.x,
            y: resetRect.y,
            width: resetRect.width,
            height: resetRect.height,
            right: resetRect.right,
            bottom: resetRect.bottom
          }
        });
        
        // ê²¹ì¹¨ ì—¬ë¶€ í™•ì¸
        const isOverlapping = !(
          startRect.right < resetRect.left || 
          resetRect.right < startRect.left || 
          startRect.bottom < resetRect.top || 
          resetRect.bottom < startRect.top
        );
        
        console.log(`${isOverlapping ? 'âŒ [WARNING]' : 'âœ… [OK]'} ë²„íŠ¼ ê²¹ì¹¨ ì—¬ë¶€: ${isOverlapping}`);
      }
      if (startBtn) {
        console.log('ğŸš€ [DEBUG] startBtnì— startGame ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡');
        startBtn.addEventListener('click', function(event) {
          console.log('ğŸ”´ [DEBUG] START ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ë°œìƒ!', event.target);
          startGame();
        });
      }
      
      if (resetBtn) {
        console.log('ğŸ”„ [DEBUG] resetBtnì— resetGame ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡');
        resetBtn.addEventListener('click', function(event) {
          console.log('ğŸ”µ [DEBUG] RESET ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ë°œìƒ!', event.target);
          resetGame();
        });
      }
      
      document.getElementById('pauseBtn')?.addEventListener('click', pauseGame);
      document.getElementById('hintBtn')?.addEventListener('click', showHint);
      document.getElementById('newGameBtn')?.addEventListener('click', () => {
        window.location.href = '../index.html';
      });
      document.getElementById('toggleAnswerBtn')?.addEventListener('click', toggleAnswerPoints);
      
      // ë””ë²„ê·¸ ëª¨ë“œ í† ê¸€
      document.getElementById('debugModeBtn')?.addEventListener('click', () => {
        debugMode = !debugMode;
        const btn = document.getElementById('debugModeBtn');
        const devTools = document.getElementById('devTools');
        
        // ë²„íŠ¼ í…ìŠ¤íŠ¸ì™€ ìƒ‰ìƒ ë™ì‹œ ì—…ë°ì´íŠ¸
        btn.textContent = debugMode ? 'ğŸ”§ ë””ë²„ê·¸ OFF' : 'ğŸ”§ ë””ë²„ê·¸ ëª¨ë“œ';
        btn.style.backgroundColor = debugMode ? '#e74c3c' : '#f39c12';
        
        // ê°œë°œì ë„êµ¬ íŒ¨ë„ í† ê¸€
        devTools.style.display = debugMode ? 'block' : 'none';
        
        showMessage(`ë””ë²„ê·¸ ëª¨ë“œ ${debugMode ? 'ON' : 'OFF'}`, 'success');
        });
        
      
      // ì´ë¯¸ì§€ í´ë¦­ ì´ë²¤íŠ¸
      const modifiedImg = document.getElementById('modifiedImage');
      if (modifiedImg) {
        modifiedImg.addEventListener('click', (event) => {
          if (debugMode) {
            debugClickHandler(event);
          } else {
            handleImageClick(event);
          }
        });
      }
      
      console.log('âœ… ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì™„ë£Œ');
    }
    
    window.addEventListener('load', async function() {
      console.log('ğŸ“± í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ, ì´ˆê¸°í™” ì‹œì‘!');
      
      try {
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        setupEventListeners();
        
        // ì¸ì¦ ìƒíƒœ ìºì‹œ í´ë¦¬ì–´ (ì¬ë¡œê·¸ì¸ ë¬¸ì œ í•´ê²°)
        clearAuthCache();
        console.log('ì¸ì¦ ìƒíƒœ ìºì‹œê°€ í´ë¦¬ì–´ë˜ì—ˆìŠµë‹ˆë‹¤.');
        
        // í™˜ê²½ë³€ìˆ˜ë¥¼ APIì—ì„œ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
        async function loadSupabaseConfig() {
          try {
            const response = await fetch('/api/config');
            const config = await response.json();
            return {
              url: config.supabaseUrl,
              anonKey: config.anon_key
            };
          } catch (error) {
            console.error('ì„¤ì • ë¡œë“œ ì˜¤ë¥˜:', error);
            // í´ë°±: í•˜ë“œì½”ë”©ëœ ê°’ ì‚¬ìš©
            return {
              url: 'https://ysvxjmqdafldfrmdscvd.supabase.co',
              anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlzdnhqbXFkYWZsZGZybWRzY3ZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDIxODU5ODMsImV4cCI6MjA1Nzc2MTk4M30.lKRd0cPCFLMJFWT1lMrp7DOAjlx85Q-pbnsXTiE22G4'
            };
          }
        }
        
        // URLì—ì„œ OAuth í† í° ì²˜ë¦¬ (Google ë¡œê·¸ì¸ ì½œë°±)
        const urlParams = new URLSearchParams(window.location.hash.substring(1));
        const accessToken = urlParams.get('access_token');
        const refreshToken = urlParams.get('refresh_token');
        const expiresIn = urlParams.get('expires_in');
        const tokenType = urlParams.get('token_type');
        const expiresAt = urlParams.get('expires_at');
        
        if (accessToken && refreshToken) {
          console.log('ğŸ”‘ OAuth í† í° ë°œê²¬, ì„¸ì…˜ ì„¤ì • ì¤‘...');
          try {
            // Supabase ì„¤ì •ì„ APIì—ì„œ ê°€ì ¸ì˜¤ê¸°
            const config = await loadSupabaseConfig();
            
            // Supabase í´ë¼ì´ì–¸íŠ¸ ê°€ì ¸ì˜¤ê¸° (ì´ë¯¸ ìƒì„±ëœ í´ë¼ì´ì–¸íŠ¸ ë˜ëŠ” ìƒˆë¡œ ìƒì„±)
            let supabaseClient = window.supabaseClient;
            if (!supabaseClient && window.supabase) {
              supabaseClient = window.supabase.createClient(config.url, config.anonKey);
              window.supabaseClient = supabaseClient;
            }
            
            const sessionData = {
              access_token: accessToken,
              refresh_token: refreshToken,
              expires_at: expiresAt ? parseInt(expiresAt) : Math.floor(Date.now() / 1000) + 3600,
              token_type: 'bearer',
              user: null // Supabaseê°€ ìë™ìœ¼ë¡œ ì„¤ì •í•¨
            };
            console.log('ğŸ“ ì„¸ì…˜ ë°ì´í„° ì„¤ì •:', {
              hasAccessToken: !!sessionData.access_token,
              hasRefreshToken: !!sessionData.refresh_token,
              expiresAt: new Date(sessionData.expires_at * 1000).toLocaleString()
            
            });
            
            const { data, error } = await supabaseClient.auth.setSession(sessionData);
            
            if (error) {
              console.error('âŒ ì„¸ì…˜ ì„¤ì • ì‹¤íŒ¨:', error);
            } else {
              console.log('âœ… ì„¸ì…˜ ì„¤ì • ì„±ê³µ:', data);
              
              // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ë„ í† í° ì €ì¥
              localStorage.setItem('supabaseToken', accessToken);
              localStorage.setItem('supabaseTokenExpiry', String(sessionData.expires_at * 1000));
              
              if (data.user) {
                localStorage.setItem('supabaseUser', JSON.stringify(data.user));
              }
            }
            
            // URL ì •ë¦¬ (í† í° ì œê±°)
            window.history.replaceState({}, document.title, window.location.pathname + window.location.search);
            console.log('ğŸ§¹ URL ì •ë¦¬ ì™„ë£Œ');
          } catch (tokenError) {
            console.warn('âš ï¸ í† í° ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:', tokenError);
          }
        }
        
        // ì¸ì¦ ìƒíƒœ ë³€ê²½ ë¦¬ìŠ¤ë„ˆ ì„¤ì • (ëŒ€ì²´ êµ¬í˜„)
        // console.log('ì¸ì¦ ìƒíƒœ ë³€ê²½ ë¦¬ìŠ¤ë„ˆ ì„¤ì •ë¨');
        
        // í† í° ì²˜ë¦¬ê°€ ìˆì—ˆë‹¤ë©´ ì ì‹œ ëŒ€ê¸° í›„ ì¸ì¦ ìƒíƒœ í™•ì¸
        if (accessToken && refreshToken) {
          await new Promise(resolve => setTimeout(resolve, 1000)); // 1ì´ˆ ëŒ€ê¸°
        }
        
        
        // ì¸ì¦ ìƒíƒœ í™•ì¸ í›„ ì‚¬ìš©ì ì •ë³´ í‘œì‹œ (ê²ŒìŠ¤íŠ¸ ëª¨ë“œ í—ˆìš©)
        try {
          const authState = await checkAuthState();
          console.log('ğŸ” í˜„ì¬ ì¸ì¦ ìƒíƒœ:', authState);
          
          // ë¡œê·¸ì¸ëœ ì‚¬ìš©ìì˜ ê²½ìš°ì—ë§Œ í•˜íŠ¸ ì‹œìŠ¤í…œ ì´ˆê¸°í™”
          if (authState.isAuthenticated && authState.user) {
            try {
              const heartInitSuccess = await window.heartSystem.init(authState.user.id);
              if (heartInitSuccess) {
                console.log('ğŸ’– í•˜íŠ¸ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì„±ê³µ');
              } else {
                console.warn('âš ï¸ í•˜íŠ¸ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì‹¤íŒ¨, ê²ŒìŠ¤íŠ¸ ëª¨ë“œë¡œ ì§„í–‰');
              }
            } catch (heartError) {
              console.warn('âš ï¸ í•˜íŠ¸ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜:', heartError.message);
              console.log('ê²ŒìŠ¤íŠ¸ ëª¨ë“œë¡œ ì§„í–‰í•©ë‹ˆë‹¤.');
            }
          } else {
            console.log('ğŸ‘¤ ê²ŒìŠ¤íŠ¸ ëª¨ë“œë¡œ ì§„í–‰í•©ë‹ˆë‹¤.');
          }
          
          await updateUserInterface();
        } catch (authError) {
          console.warn('âš ï¸ ì¸ì¦ í™•ì¸ ì‹¤íŒ¨:', authError.message);
          console.log('ê²ŒìŠ¤íŠ¸ ëª¨ë“œë¡œ ì§„í–‰í•©ë‹ˆë‹¤.');
          await updateUserInterface();
        }
        
        // ì‹œê°„ ì œí•œ ì‹œê°í™” ì‹œìŠ¤í…œ ì´ˆê¸°í™”
        console.log('ğŸ” healthBarSystem ì¡´ì¬ ì—¬ë¶€:', typeof window.healthBarSystem);
        if (typeof window.healthBarSystem !== 'undefined') {
          console.log('ğŸ” healthBarSection DOM ìš”ì†Œ ìƒíƒœ:', {
            ìš”ì†Œì¡´ì¬: !!document.getElementById('healthBarSection'),
            í´ë˜ìŠ¤: document.getElementById('healthBarSection')?.className,
            í‘œì‹œìƒíƒœ: document.getElementById('healthBarSection') ? window.getComputedStyle(document.getElementById('healthBarSection')).display : 'N/A'
          });
          
          const healthBarInitSuccess = window.healthBarSystem.init();
          if (healthBarInitSuccess) {
            console.log('â±ï¸ ì‹œê°„ ì œí•œ ì‹œê°í™” ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì„±ê³µ');
          } else {
            console.warn('âš ï¸ ì‹œê°„ ì œí•œ ì‹œê°í™” ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì‹¤íŒ¨');
          }
        } else {
          console.error('âŒ healthBarSystemì´ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!');
        }
        
        // ê²Œì„ ë°ì´í„° ë¡œë”©
        await loadGameData();
        
        // ì²´ë ¥ë°” ì‹œìŠ¤í…œ ì‹œì‘ (ê²Œì„ ë°ì´í„° ë¡œë”© í›„)
        if (typeof window.healthBarSystem !== 'undefined') {
          console.log('ğŸš€ ì²´ë ¥ë°” ì‹œìŠ¤í…œ ìˆ˜ë™ ì‹œì‘...');
          window.healthBarSystem.start();
          console.log('âœ… ì²´ë ¥ë°” ì‹œìŠ¤í…œ ìˆ˜ë™ ì‹œì‘ ì™„ë£Œ');
        }
        
        // UI ì—…ë°ì´íŠ¸
        updateUI();
        
        showMessage('ê²Œì„ ì¤€ë¹„ ì™„ë£Œ! ì‹œì‘ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.', 'success');
        
      } catch (error) {
        console.error('âŒ ê²Œì„ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
        showMessage(`ê²Œì„ ì´ˆê¸°í™” ì‹¤íŒ¨: ${error.message}`, 'error');
      }
    });
    
    /**
     * ì‚¬ìš©ì ì¸í„°í˜ì´ìŠ¤ ì—…ë°ì´íŠ¸
     */
    async function updateUserInterface() {
      const userSection = document.getElementById('userSection');
      const bestScoreSection = document.getElementById('bestScoreSection');
      const bestScoreEl = document.getElementById('bestScore');
      
      try {
                const authState = await checkAuthState();
        
        if (userSection) {
          if (authState.isAuthenticated && authState.user) {
            // ë¡œê·¸ì¸ ìƒíƒœ UI
            userSection.innerHTML = `
              <div class="user-info">
                <div class="user-avatar">
                  <img src="${authState.user.user_metadata?.avatar_url || 'https://via.placeholder.com/40x40/4CAF50/FFFFFF?text=U'}" 
                       alt="í”„ë¡œí•„" style="width: 40px; height: 40px; border-radius: 50%;">
                </div>
                <div class="user-details">
                  <div class="user-name">ğŸ‘‹ ${authState.user.user_metadata?.full_name || authState.user.email}</div>
                  <div class="user-email">${authState.user.email}</div>
                </div>
                <button onclick="logout()" class="control-btn btn-secondary" style="margin-top: 10px;">ë¡œê·¸ì•„ì›ƒ</button>
              </div>
            `;
          } else {
            // ê²ŒìŠ¤íŠ¸ ìƒíƒœ UI
            userSection.innerHTML = `
              <div class="guest-info">
                <div class="guest-message">
                  <span>ğŸ® ê²ŒìŠ¤íŠ¸ ëª¨ë“œ</span>
                  <div style="font-size: 12px; color: #888; margin: 5px 0;">
                    ë¡œê·¸ì¸í•˜ë©´ ë” ë§ì€ ê¸°ëŠ¥ì„ ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!
                  </div>
                </div>
                <button onclick="loginWithGoogle()" class="control-btn btn-primary" style="margin-top: 10px;">
                  <span>ğŸ”‘ êµ¬ê¸€ ë¡œê·¸ì¸</span>
                </button>
              </div>
            `;
          }
        }
        
        // ë¡œê·¸ì¸ëœ ì‚¬ìš©ìì˜ ìµœê³  ì ìˆ˜ í‘œì‹œ
        if (authState.isAuthenticated && bestScoreSection && bestScoreEl) {
          try {
            // ìµœê³  ì ìˆ˜ ê¸°ëŠ¥ì€ í–¥í›„ êµ¬í˜„ ì˜ˆì •
            if (bestScoreSection) {
              bestScoreSection.style.display = 'none';
            }
          } catch (error) {
            console.log('ìµœê³  ì ìˆ˜ APIê°€ êµ¬í˜„ë˜ì§€ ì•ŠìŒ:', error.message);
            if (bestScoreSection) {
              bestScoreSection.style.display = 'none';
            }
          }
        }
      } catch (error) {
        console.error('ì‚¬ìš©ì ì¸í„°í˜ì´ìŠ¤ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
      }
    }
    
    // ê²Œì„ ì‹œì‘ ì „ ì •ë‹µ ì˜ì—­ ìˆ¨ê¹€
    window.addEventListener('beforeunload', () => {
      hideAnswerPoints();
    });

    /**
     * ê°œë°œììš© íŒíŠ¸ ë¦¬ì…‹ í•¨ìˆ˜
     */
    async function resetDeveloperHints() {
      try {
                const authState = await checkAuthState();
        
        // ë¡œê·¸ì¸ëœ ì‚¬ìš©ìì¸ì§€ í™•ì¸ (ê°œë°œì ê¶Œí•œì€ í–¥í›„ êµ¬í˜„)
        if (authState.isAuthenticated) {
          // íŒíŠ¸ ë°ì´í„° ë¦¬ì…‹ ë¡œì§ (í–¥í›„ êµ¬í˜„ ì˜ˆì •)
          showMessage('ğŸ› ï¸ íŒíŠ¸ ë¦¬ì…‹ ê¸°ëŠ¥ì€ í–¥í›„ êµ¬í˜„ ì˜ˆì •ì…ë‹ˆë‹¤.', 'success');
        } else {
          showMessage('ì´ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error');
        }
      } catch (error) {
        console.error('ê°œë°œì íŒíŠ¸ ë¦¬ì…‹ ì˜¤ë¥˜:', error);
        showMessage('ê¸°ëŠ¥ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
      }
    }

    // ì „ì—­ í•¨ìˆ˜ë¡œ ë…¸ì¶œ
    window.showLoading = showLoading;
    window.showMessage = showMessage;
    window.resetDeveloperHints = resetDeveloperHints;
    
    // authModuleì„ ì „ì—­ authManagerë¡œ ë…¸ì¶œ (ëŒ€ì²´ êµ¬í˜„)
    // window.authManager = authModule;
    
    // ì¸ì¦ ê´€ë ¨ ì „ì—­ í•¨ìˆ˜
    window.loginWithGoogle = async () => {
      try {
        // ê°„ë‹¨í•œ êµ¬ê¸€ ë¡œê·¸ì¸ ëŒ€ì²´ êµ¬í˜„
        console.log('êµ¬ê¸€ ë¡œê·¸ì¸ ìš”ì²­');
        // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
        window.location.href = '/login.html';
      } catch (error) {
        console.error('êµ¬ê¸€ ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜:', error);
        showMessage('ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
      }
    };
    window.logout = async () => {
      try {
        // ì¸ì¦ ìºì‹œ ë¨¼ì € í´ë¦¬ì–´
        clearAuthCache();
        
        // ê°„ë‹¨í•œ ë¡œê·¸ì•„ì›ƒ ëŒ€ì²´ êµ¬í˜„
        console.log('ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬');
        localStorage.removeItem('supabaseToken');
        localStorage.removeItem('supabaseUser');
        localStorage.removeItem('supabaseTokenExpiry');
        
        showMessage('ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.', 'success');
        // 2ì´ˆ í›„ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
        setTimeout(() => {
          window.location.href = '/login.html';
        }, 2000);
      } catch (error) {
        console.error('ë¡œê·¸ì•„ì›ƒ ì¤‘ ì˜¤ë¥˜:', error);
        showMessage('ë¡œê·¸ì•„ì›ƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
      }
    };
    </script>
    
    
    </body>
    </html>